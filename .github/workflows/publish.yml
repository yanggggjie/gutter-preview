name: Publish to VS Code Marketplace

on:
    push:
        branches:
            - release
    pull_request:
        branches:
            - release
        types:
            - closed

jobs:
    publish:
        # 只在直接推送到 release 或 PR 合并到 release 时运行
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
        runs-on: ubuntu-latest

        permissions:
            contents: write
            actions: write

        steps:
            - name: 检出代码
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: 启用 Corepack
              run: corepack enable

            - name: 安装依赖
              run: yarn install --frozen-lockfile

            - name: 安装 vsce
              run: yarn global add @vscode/vsce

            - name: 打包扩展
              run: vsce package

            - name: 发布到 VS Code Marketplace
              run: vsce publish -p ${{ secrets.VSCE_PAT }}
              env:
                  VSCE_PAT: ${{ secrets.VSCE_PAT }}

            - name: 上传 VSIX 文件
              uses: actions/upload-artifact@v4
              with:
                  name: vscode-extension
                  path: '*.vsix'
                  retention-days: 30

            - name: 创建 GitHub Release
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  files: '*.vsix'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
